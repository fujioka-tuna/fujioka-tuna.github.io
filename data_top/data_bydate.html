<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>調査日ごとの概要 | 三保地引網</title>
  <link rel="icon" href="/tab_icon.jpg" type="image/jpeg">
  <link rel="stylesheet" href="/common.css">
</head>
<body>

  <div id="header-placeholder"></div>

  <main>
    <div class="page-header">
        <h1 class="page-title lang-ja">調査日ごとの概要</h1>
        <h1 class="page-title lang-en" style="display:none;">Daily Summary</h1>
        <p class="page-subtitle lang-ja">調査を実施した日に色がついています。カレンダーから日付を選択すると、その日の ひとこと が表示されます。</p>
        <p class="page-subtitle lang-en" style="display:none;">Select a date from the calendar to view catch data and sea conditions for that day.</p>
    </div>
    <div class="main-content">
        <div class="container">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prev-month-btn">&lt;</button>
                    <h2 id="month-year"></h2>
                    <button id="next-month-btn">&gt;</button>
                </div>
                <div class="calendar-grid" id="weekdays">
                    <div class="day-name">日</div>
                    <div class="day-name">月</div>
                    <div class="day-name">火</div>
                    <div class="day-name">水</div>
                    <div class="day-name">木</div>
                    <div class="day-name">金</div>
                    <div class="day-name">土</div>
                </div>
                <div class="calendar-grid" id="calendar-days"></div>
            </div>

            <div id="summary-container">
                <h3 id="summary-date" class="lang-ja">日付を選択してください</h3>
                <h3 id="summary-date-en" class="lang-en" style="display:none;">Please select a date</h3>
                <div id="summary-content">
                    <p class="lang-ja">ここに選択した日付のデータが表示されます。</p>
                    <p class="lang-en" style="display:none;">Data for the selected date will be displayed here.</p>
                </div>
            </div>
        </div>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const monthYearElement = document.getElementById('month-year');
      const calendarDaysElement = document.getElementById('calendar-days');
      const prevMonthBtn = document.getElementById('prev-month-btn');
      const nextMonthBtn = document.getElementById('next-month-btn');
      const summaryDateElement = document.getElementById('summary-date');
      const summaryDateEnElement = document.getElementById('summary-date-en');
      const summaryContentElement = document.getElementById('summary-content');

      let currentDate = new Date();

      let eventData = {};
      let dataAvailableDates = [];

      const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSbkjjPC-k8v8KupkFQwPq1dsEZ7CyG7T0mN61ZNc5gGDHbHls2X1tlfrn2Dc1LRZj3BIQxwR2xrqUv/pub?gid=0&single=true&output=csv';
      
      function parseCsvRow(rowString) {
          const values = [];
          let inQuotes = false;
          let currentValue = '';
          
          for (let i = 0; i < rowString.length; i++) {
              const char = rowString[i];
              
              if (char === '"') {
                  if (inQuotes && i + 1 < rowString.length && rowString[i+1] === '"') {
                      currentValue += '"';
                      i++;
                  } else {
                      inQuotes = !inQuotes;
                  }
              } else if (char === ',' && !inQuotes) {
                  values.push(currentValue);
                  currentValue = '';
              } else {
                  currentValue += char;
              }
          }
          values.push(currentValue);
          
          return values.map(v => {
              let value = v.trim();
              if (value.startsWith('"') && value.endsWith('"')) {
                  value = value.substring(1, value.length - 1).replace(/""/g, '"');
              }
              return value;
          });
      }

      async function fetchDataAndRender() {
        try {
          const response = await fetch(SPREADSHEET_URL);
          if (!response.ok) {
            throw new Error(`Network response was not ok (status: ${response.status})`);
          }
          const csvText = await response.text();
          
          const lines = csvText.split('\n');
          if (lines.length === 0) {
              renderCalendar();
              return;
          }

          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          const dateIndex = headers.indexOf('date');
          const jaIndex = headers.indexOf('summary_ja');
          const enIndex = headers.indexOf('summary_en');

          if (dateIndex === -1 || jaIndex === -1 || enIndex === -1) {
              console.error('必要な列 (date, summary_ja, summary_en) がCSVヘッダーに見つかりません:', headers);
              renderCalendar();
              return;
          }

          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            
            const row = parseCsvRow(lines[i]);
            
            if(row.length <= Math.max(dateIndex, jaIndex, enIndex)) continue;

            const dateStr = row[dateIndex];
            const summaryJa = row[jaIndex];
            const summaryEn = row[enIndex];

            if (dateStr) {
              let formattedDate = dateStr.replace(/\//g, '-');
              
              if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(formattedDate)) {
                  const parts = formattedDate.split('-');
                  const finalDateStr = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                  
                  eventData[finalDateStr] = { 
                      ja: summaryJa || '',
                      en: summaryEn || '' 
                  };
                  dataAvailableDates.push(finalDateStr);
              } else {
                  console.warn('無視された日付形式:', dateStr);
              }
            }
          }
          
        } catch (error) {
          console.error('スプレッドシートデータの取得に失敗しました:', error);
        }
        
        renderCalendar();
      }

      const escapeHTML = (str) => {
          if (!str) return '';
          return str.replace(/[&<>"']/g, (match) => {
              return {
                  '&': '&amp;',
                  '<': '&lt;',
                  '>': '&gt;',
                  '"': '&quot;',
                  "'": '&#39;'
              }[match];
          });
      };
      
      const formatSummary = (str) => escapeHTML(str).replace(/\n/g, '<br>');

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthYearElement.textContent = `${year}年 ${month + 1}月`;
        calendarDaysElement.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
          const emptyDiv = document.createElement('div');
          emptyDiv.classList.add('day', 'empty');
          calendarDaysElement.appendChild(emptyDiv);
        }

        for (let i = 1; i <= daysInMonth; i++) {
          const dayDiv = document.createElement('div');
          dayDiv.classList.add('day');
          dayDiv.textContent = i;
          
          const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          
          if (dataAvailableDates.includes(dateString)) {
              dayDiv.classList.add('has-data');
          }

          dayDiv.addEventListener('click', () => {
              document.querySelectorAll('.day.selected').forEach(d => d.classList.remove('selected'));
              dayDiv.classList.add('selected');
              
              summaryDateElement.textContent = `${year}年${month + 1}月${i}日の概要`;
              summaryDateEnElement.textContent = `Summary for ${year}-${month + 1}-${i}`;

              const data = eventData[dateString];
              if (data) {
                  summaryContentElement.innerHTML = 
                      `<p class="lang-ja">${formatSummary(data.ja)}</p>` +
                      `<p class="lang-en" style="display:none;">${formatSummary(data.en)}</p>`;
              } else {
                  summaryContentElement.innerHTML = 
                      `<p class="lang-ja">この日のデータはありません。</p>` +
                      `<p class="lang-en" style="display:none;">No data available for this day.</p>`;
              }
              
              if (typeof setLanguage === 'function') {
                  setLanguage(window.currentLang || 'ja');
              } else {
                  const currentLang = document.getElementById('lang-toggle')?.textContent === '日本語' ? 'en' : 'ja';
                  document.querySelectorAll('.lang-ja').forEach(el => el.style.display = currentLang === 'ja' ? '' : 'none');
                  document.querySelectorAll('.lang-en').forEach(el => el.style.display = currentLang === 'en' ? '' : 'none');
              }
          });
          calendarDaysElement.appendChild(dayDiv);
        }
      }

      prevMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      });

      nextMonthBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      });

      fetchDataAndRender();
    });
  </script>

  <script src="/common.js"></script>

</body>
</html>
